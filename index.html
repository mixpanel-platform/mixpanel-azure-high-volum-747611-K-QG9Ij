<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
    <style>
      #run {
        margin-top:5px;
        float:left;
        clear:both;
        padding: 6px 12px;
        background-color: #61adf0;
        background-image: -webkit-linear-gradient(#6ab5f2,#53a0ee);
        background-image: linear-gradient(#6ab5f2,#53a0ee);
        box-shadow: inset 0 1px 1px #77bdf4,0 2px 2px -1px rgba(0,0,0,0.2);
        text-transform: uppercase;
        border: 1px solid #4d93d7;
        color: #fff;
        text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        border-radius: 3px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="dateRange" style="float: left;"></div>
      <button id="run" value="Run">Run</button>
      <div style="clear:both"></div>
    </div>
    <table id="table" class="display" width="100%"></table>
    <script>
     function naturalSort (a, b) {
        aLower = suffix(a.split(' - ')[0].replace(',',''));
        bLower = suffix(b.split(' - ')[0].replace(',',''));
        return aLower - bLower;
      }
      
      function obj2array(json_data){
        var result = [];
        _.each(_.keys(json_data), function(key) {
          result.push(key);
        });
        return result;
      }
      
      function suffix(numberString){
        length = numberString.length;
        lastChar = numberString[length - 1]
        number = Number(numberString.slice(0, length - 1))
        switch (lastChar) {
          case 'K':
            value = number * 1000
            break;
          case 'B':
            value = number * 1000000000
            break;
          case 'M':
            value = number * 1000000
            break;
          default:
            value = Number(numberString)
            break;
        } 
        return value
      }
      var eventSelector = $('#eventSelect').MPEventSelect({limit: 500});
      var dateSelector = $('#dateRange').MPDatepicker();
      var eventName, dates;
      
      $('#table').DataTable({
        columns: [
          { title: "Date", data: "Date" },
          { title: "Median Percentile Portal Ready", data: "Median Percentile for TotalTimeToPortalReady Ready" },
          { title: "95th Percentile Portal Ready", data: "95th Percentile for TotalTimeToPortalReady Ready" },
          { title: "Median Percentile StartBoard Ready", data: "Median Percentile for TotalTimeToStartBoardReady Ready" },
          { title: "95th Percentile StartBoard Ready", data: "95th Percentile for TotalTimeToStartBoardReady Ready" },
          { title: "Median Percentile DeepLink Ready", data: "Median Percentile for TotalTimeToDeepLinkReady Ready" },
          { title: "95th Percentile Deeplink Ready", data: "95th Percentile for TotalTimeToDeepLinkReady Ready" },
        ]
      })
      nestedQuery = function (percentile, parameters, event, date) {
        result[date][event][percentile] = result[date][event][percentile] || {count: 0};
        var endpoint = 'https://mixpanel.com/api/2.0/segmentation/numeric';
        MP.api.query(endpoint, parameters).done(function(Data){
          var queryData = result[date][event][percentile]
          queryData.total = queryData.total || MP.Data.inst(Data.data.values).sum().sum().values();
          var tempParams = parameters
          var queryBuckets = MP.Data.inst(Data.data.values).sum().values();
          var queryList = obj2array(queryBuckets).sort(naturalSort);
          
          for (index in queryList) {
            var queryBucket = queryList[index];
            var counts = queryBuckets[queryBucket]
            if ((queryData['count'] + counts) / queryData['total'] >= percentile) {
              break;
            }
            queryData['count'] += queryBuckets[queryBucket];
          }
          try {
            var queryBounds = queryBucket.replace(/,/g,'').split(' - ');
            queryBounds = queryBounds.map(suffix)
          }
          catch(err){
            console.log(event, date)
          }
         if (percentile == .5){
            percentileStr = 'Median'
          } else {
            percentileStr = '95th'
          }
          if (queryBounds.length == 1) {
            queryData.value = queryBounds[0]
            debugger;
            tableData[date] = tableData[date] || {}
            tableData[date][String(percentileStr + ' ' + event)] = queryBounds[0]
            debugger;
            var table = $('#table').DataTable();
            table.clear()
            for (rowDate in tableData) {
              table.row.add({
                'Date': rowDate,
                'Median Percentile for TotalTimeToPortalReady': tableData[rowDate]['Median TotalTimeToPortalReady'] ,
                '95th Percentile for TotalTimeToPortalReady': tableData[rowDate]['95th TotalTimeToPortalReady'],
                'Median Percentile for TotalTimeToStartBoardReady': tableData[rowDate]['Median TotalTimeToStartBoardReady'],
                '95th Percentile for TotalTimeToStartBoardReady': tableData[rowDate]['95th TotalTimeToStartBoardReady'],
                'Median Percentile for TotalTimeToDeepLinkReady': tableData[rowDate]['Median TotalTimeToDeepLinkReady'],
                '95th Percentile for TotalTimeToDeepLinkReady': tableData[rowDate]['95th TotalTimeToDeepLinkReady'],
              })
            }
            table.draw();
          } else {
            tableData[date][String(percentileStr + ' ' + event)] = 'Pending'
            var zero = 'number(properties["Duration"]) > 0 and '
            var lowerBound = '(number(properties["Duration"]) >= ' + queryBounds[0];
            var upperBound = ' and number(properties["Duration"]) <=' + queryBounds[1]+ ')';
            tempParams.where = zero + lowerBound + upperBound;
            nestedQuery(percentile, tempParams, event, date);
          }
        });
      }
      
      // Query logic
      var runQuery = function(){
        var params = {}
        tableData = {}
        var table = $('#table').DataTable();
        table
          .clear()
          .draw();
          
        endpoint = 'https://mixpanel.com/api/2.0/segmentation/numeric'
        eventList = ['TotalTimeToPortalReady', 'TotalTimeToStartBoardReady', 'TotalTimeToDeepLinkReady']
        percentiles = [.5, .95]
        result = {}
        
        while (new Date(dates.from) <= new Date(dates.to)) { 
          myDate = new Date(dates.from)
          console.log (myDate)

          var date = dates.from.toLocaleString().split(',')[0]
          result[date] = {};
          dates.from = myDate

          for (var index in eventList) {
            var event = eventList[index]
            params[event] = {}
            result[date][event] = {};
            for (percentIndex in percentiles){
              percent = percentiles[percentIndex]
              params[event][percent] = {
                event: event,
                where: 'number(properties["Duration"]) > 0',
                from: dates.from.toISOString().split('T')[0],
                to: dates.from.toISOString().split('T')[0],
                on: 'number(properties["Duration"])',
                unit: 'day',
                buckets: 2,
                allow_more_buckets:true,
              };
              nestedQuery(percent, params[event][percent], event, date);
            }
          }
          myDate.setDate(myDate.getDate() + 1);
        }
      };
      
      $('#run').on('click', function(e){
        dates = $('#dateRange').val();
        runQuery();
      });
    </script>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
    <style>
      #run {
        margin-top:5px;
        float:left;
        clear:both;
        padding: 6px 12px;
        background-color: #61adf0;
        background-image: -webkit-linear-gradient(#6ab5f2,#53a0ee);
        background-image: linear-gradient(#6ab5f2,#53a0ee);
        box-shadow: inset 0 1px 1px #77bdf4,0 2px 2px -1px rgba(0,0,0,0.2);
        text-transform: uppercase;
        border: 1px solid #4d93d7;
        color: #fff;
        text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        border-radius: 3px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="dateRange" style="float: left;"></div>
      <button id="run" value="Run">Run</button>
      <div style="clear:both"></div>
    </div>
    <table id="table" class="display" width="100%"></table>
    <script>
      var eventSelector = $('#eventSelect').MPEventSelect({limit: 500});
      var dateSelector = $('#dateRange').MPDatepicker();
      var eventName, dates;
      
      $('#table').DataTable({
        columns: [
          { title: "Percentile", data: "Percentile" },
          { title: "Value", data: "Value" }  
        ]
      });
      
      function naturalSort (a, b) {
        aLower = suffix(a.split(' - ')[0].replace(',',''));
        bLower = suffix(b.split(' - ')[0].replace(',',''));
        return aLower - bLower;
      }
      
      function obj2array(json_data){
        var result = [];
        _.each(_.keys(json_data), function(key) {
          result.push(key);
        });
        return result;
      }
      
      function suffix(numberString){
        length = numberString.length;
        lastChar = numberString[length - 1]
        number = Number(numberString.slice(0, length - 1))
        switch (lastChar) {
          case 'K':
            value = number * 1000
            break;
          case 'B':
            value = number * 1000000000
            break;
          case 'M':
            value = number * 1000000
            break;
          default:
            value = Number(numberString)
            break;
        } 
        return value
      }
      
      nestedQuery = function (percentile, params, event, date) {
        // var date = params.from.toLocaleString().split(',')[0]
        result[date][event][percentile] = result[date][event][percentile] || {count: 0};
        var endpoint = 'https://mixpanel.com/api/2.0/segmentation/numeric';
        console.log(result);
        MP.api.query(endpoint, params).done(function(Data){
          // date = params.from.toLocaleString().split(',')[0]
          var queryData = result[date][event][percentile]
          queryData.total = queryData.total || MP.Data.inst(Data.data.values).sum().sum().values()
          var queryTotal = queryData.total
          var tempParams = params
          var queryBuckets = MP.Data.inst(Data.data.values).sum().values();
          var queryList = obj2array(queryBuckets).sort(naturalSort);
          var queryIndex = 0;
          while (queryData['count'] / queryData['total'] < percentile){
            var queryBucket = queryList[queryIndex];
            queryData['count'] += queryBuckets[queryBucket];
            queryIndex++;
          }
          try {
            var queryBounds = queryBucket.replace(/,/g,'').split(' - ');
          }
          catch(err) {
            debugger
          }
          queryData['count'] -= queryBuckets[queryBucket];
          for (bound in queryBounds) { 
            queryBounds[bound] = suffix(queryBounds[bound])
          }
          
          if (queryBounds.length == 1) {
            //need to use result object instead
            var table = $('#table').DataTable();
            table.row.add({
              'Percentile': percentile, 
              'Value': queryBounds[0]
            }).draw();
          } else {
            var zero = 'number(properties["Duration"]) > 0 and '
            var lowerBound = '(number(properties["Duration"]) >= ' + queryBounds[0];
            var upperBound = ' and number(properties["Duration"]) <=' + queryBounds[1]+ ')';
            tempParams.where = zero + lowerBound + upperBound;
            nestedQuery(percentile, tempParams, event, date);
          }
        });
      }
      
      // Query logic
      var runQuery = function(){
        var params = {}
        var table = $('#table').DataTable();
        table
          .clear()
          .draw();
          
        endpoint = 'https://mixpanel.com/api/2.0/segmentation/numeric'
        eventList = ['TotalTimeToPortalReady', 'TotalTimeToStartboardReady', 'TotalTimeToDeepLinkReady']
        result = {}
        
        while (new Date(dates.from) <= new Date(dates.to)) { 
          var myDate = new Date(dates.from)
          console.log (myDate)
          myDate.setDate(myDate.getDate() + 1);

          var date = dates.from.toLocaleString().split(',')[0]
          result[date] = {};
          dates.from = myDate

          for (var index in eventList){
            var event = eventList[index]
            params[event] = {
              where: 'number(properties["Duration"]) > 0',
              from: dates.from,
              to: dates.from,
              on: 'number(properties["Duration"])',
              unit: 'day',
              buckets: 12,
              allow_more_buckets:false,
            };
            params[event].event = event
            
            result[date][event] = {};
            console.log(event);
            console.log(date);
            nestedQuery(.5, params[event], event, date);
            // nestedQuery(.95, params, total, 0);
          }
        }
      };
      
      $('#run').on('click', function(e){
        dates = $('#dateRange').val();
        runQuery();
      });
    </script>
  </body>
</html>
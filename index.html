<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
    <style>
      #run {
        margin-top:5px;
        float:left;
        clear:both;
        padding: 6px 12px;
        background-color: #61adf0;
        background-image: -webkit-linear-gradient(#6ab5f2,#53a0ee);
        background-image: linear-gradient(#6ab5f2,#53a0ee);
        box-shadow: inset 0 1px 1px #77bdf4,0 2px 2px -1px rgba(0,0,0,0.2);
        text-transform: uppercase;
        border: 1px solid #4d93d7;
        color: #fff;
        text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        border-radius: 3px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="dateRange" style="float: left;"></div>
      <button id="run" value="Run">Run</button>
      <div style="clear:both"></div>
    </div>
    <table id="table" class="display" width="100%"></table>
    <script>
     function naturalSort (a, b) {
        aLower = suffix(a.split(' - ')[0].replace(/,/g,''));
        bLower = suffix(b.split(' - ')[0].replace(/,/g,''));
        return aLower - bLower;
      }
      
      function obj2array(json_data){
        var result = [];
        _.each(_.keys(json_data), function(key) {
          result.push(key);
        });
        return result;
      }
      
      function suffix(numberString){
        length = numberString.length;
        lastChar = numberString[length - 1]
        number = Number(numberString.slice(0, length - 1))
        switch (lastChar) {
          case 'K':
            value = number * 1000
            break;
          case 'B':
            value = number * 1000000000
            break;
          case 'M':
            value = number * 1000000
            break;
          default:
            value = Number(numberString)
            break;
        } 
        return value
      }
      proto = document.location.protocol;
      setUrl = proto + "//api.mixpanel.com/engage";
      getUrl = proto + "//mixpanel.com/api/2.0/engage";

      set = function(data, distinct) {
        update = {
          "$set": data,
        }
        send(update, distinct);
      }
      
      append = function(data, distinct) {
        console.log('appending data', data);
        update = {
          "$append": data,
        } 
        send(update, distinct);
      }

      send = function(update, distinct) {
        token = "5e1e1a9c5b3420a5700f9daa06c94c16"
        console.log(token)
        $.extend(update, {
          "$token": token,
          "$distinct_id": distinct
        })
        
        payload = { 'data': btoa(JSON.stringify(update)), "ip": 0, "verbose": 1 };
        console.log('set', payload)
        setXHR = new XMLHttpRequest();
        setXHR.open("POST", setUrl, true);
        setXHR.send($.param(payload))
      };

      //retrieve the user/database
      get = function(distinct) {
        return MP.api.query('/api/2.0/engage', {'distinct_id': distinct})
      }
      
      var eventSelector = $('#eventSelect').MPEventSelect({limit: 500});
      var dateSelector = $('#dateRange').MPDatepicker();
      var eventName, dates;
      
      $('#table').DataTable({
        columns: [
          { title: "Date", data: "Date" },
          { title: "Median Percentile Portal Ready", data: "Median Percentile TotalTimeToPortalReady" },
          { title: "95th Percentile Portal Ready", data: "0.95 TotalTimeToPortalReady" },
          { title: "Median Percentile StartBoard Ready", data: "0.5 TotalTimeToStartBoardReady" },
          { title: "95th Percentile StartBoard Ready", data: "0.95 TotalTimeToStartBoardReady" },
          { title: "Median Percentile DeepLink Ready", data: "0.5 TotalTimeToDeepLinkReady" },
          { title: "95th Percentile Deeplink Ready", data: "0.95 TotalTimeToDeepLinkReady" },
        ]
      })
      
      nestedQuery = function (percentile, parameters, event, date) {
        result[date][event][percentile] = result[date][event][percentile] || {count: 0};
        var endpoint = 'https://mixpanel.com/api/2.0/segmentation/numeric';
        MP.api.query(endpoint, parameters).done(function(Data){
          var queryData = result[date][event][percentile]
          queryData.total = queryData.total || MP.Data.inst(Data.data.values).sum().sum().values();
          var tempParams = parameters
          var queryBuckets = MP.Data.inst(Data.data.values).sum().values();
          var queryList = obj2array(queryBuckets).sort(naturalSort);
          
          for (index in queryList) {
            var queryBucket = queryList[index];
            var counts = queryBuckets[queryBucket]
            if ((queryData['count'] + counts) / queryData['total'] >= percentile) {
              break;
            }
            queryData['count'] += queryBuckets[queryBucket];
          }
          try {
            var queryBounds = queryBucket.replace(/,/g,'').split(' - ');
            queryBounds = queryBounds.map(suffix)
          }
          catch(err){
            console.log(event, date)
            pending -= 1;
          }

          tableData[date] = tableData[date] || {}
          
          if (queryBounds.length == 1) {
            queryData.value = queryBounds[0]
            var eventKey = String(percentile + ' ' + event)
            tableData[date][eventKey] = queryBounds[0]
            pending -= 1;
            console.log(pending);
            var sendData = {}
            sendData[eventKey] = queryBounds[0]
            set(sendData, date)
            if (pending == 0) {
              drawTable(tableData)
            }
          } else {
            tableData[date][String(percent + ' ' + event)] = 'Pending'
            var zero = 'number(properties["Duration"]) > 0 and '
            var lowerBound = '(number(properties["Duration"]) >= ' + queryBounds[0];
            var upperBound = ' and number(properties["Duration"]) <=' + queryBounds[1]+ ')';
            tempParams.where = zero + lowerBound + upperBound;
            nestedQuery(percentile, tempParams, event, date);
          }
        });
      }
      
      function drawTable(data){
        debugger
        var rows = []
        var table = $('#table').DataTable();
        for (rowDate in data) {
          var value = tableData[rowDate]
          rows.push({
            'Date': rowDate,
            'Median Percentile TotalTimeToPortalReady': value['0.5 TotalTimeToPortalReady'],
            '0.95 TotalTimeToPortalReady': value['0.95 TotalTimeToPortalReady'],
            '0.5 Percentile TotalTimeToStartBoardReady': value['0.5 TotalTimeToStartBoardReady'],
            '0.95 Percentile TotalTimeToStartBoardReady': value['0.95 TotalTimeToStartBoardReady'],
            '0.5 Percentile TotalTimeToDeepLinkReady': value['0.5 TotalTimeToDeepLinkReady'],
            '0.95 Percentile TotalTimeToDeepLinkReady': value['0.95 TotalTimeToDeepLinkReady'],
          })
        }
        
        table.DataTable( {
          data: data,
        }).draw();
      }
      
      // Query logic
      var runQuery = function(){
        var params = {}
        tableData = {}
        datePromises = []
        dateArray = []
        pending = 0;
        var table = $('#table').DataTable();
        table
          .clear()
          .draw();
          
        endpoint = 'https://mixpanel.com/api/2.0/segmentation/numeric'
        eventList = ['TotalTimeToPortalReady', 'TotalTimeToStartBoardReady', 'TotalTimeToDeepLinkReady']
        percentiles = [.5, .95]
        result = {}
        
        while (new Date(dates.from) <= new Date(dates.to)) { 
          myDate = new Date(dates.from)
          console.log (myDate)

          var date = dates.from.toLocaleString().split(',')[0]
          result[date] = {};
          tmpResults = {};
          myDate.setDate(myDate.getDate() + 1);
          dates.from = myDate
          datePromises.push(get(date));
          dateArray.push(date)
        }
          
        Promise.all(datePromises).then(function(promiseArray){
          for (index in promiseArray) {
            var date = dateArray[index]
            var data = promiseArray[index]
            results = data.results[0]
            if (!$.isEmptyObject(results)) {
              tableData[date] = results.$properties
            }
          }
          for (var index in eventList) {
            var event = eventList[index]
            params[event] = {}
            result[date][event] = {};
            for (percentIndex in percentiles){
              percent = percentiles[percentIndex]
              params[event][percent] = {
                event: event,
                where: 'number(properties["Duration"]) > 0',
                from: dates.from.toISOString().split('T')[0],
                to: dates.from.toISOString().split('T')[0],
                on: 'number(properties["Duration"])',
                unit: 'day',
                buckets: 2,
                allow_more_buckets:true,
              };
              var eventKey = String(percent + ' ' + event)
              if (isNaN(tableData[date][eventKey])) {
                console.log("Cache non existant: " + date)
                pending += 1;
                nestedQuery(percent, params[event][percent], event, date);
              }
            }
          }
          if (pending == 0) {
            drawTable(tableData)
          }
        });
      }
      
      $('#run').on('click', function(e){
        dates = $('#dateRange').val();
        runQuery();
      });
    </script>
  </body>
</html>